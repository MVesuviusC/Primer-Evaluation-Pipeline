# Primer evaluation



## Overview

PrimerTree is a tool I have used a lot for evaluating how well a primer set will work for metabarcoding. However I've run into some limitations with these analyses, which led me to put this package together. There were two primary motivations to create this package:

   1) Create a version of primerTree that can be run without reliance on the NCBI servers
   
Currently, there are limits on the number or queries that can be submitted to the NCBI servers (10/second with an api key). This makes running multiple primerTree analyses simultaneously problematic.
   
   2) Generate much more extensive set of metrics to quantify the quality of data produced by each primer set when used for metabarcoding.
   
PrimerTree creates a phylogenetic tree and can calculate the distance between sequences within a species/genus. 

PrimerMiner produces a list of amplifiable species and a score for the quality of the primers

ObiTools produces a list of amplifiable species and generates some metrics for taxonomic specificity

All of these tools lack description for some key aspects of the data generated by the assay.

Specifically:
   
   * Numeric outputs of primer mismatch counts/locations
   * Numeric output for the proportion of sequenced species that can be amplified
   * Identity of both amplifiable and *non-amplifiable* species
   * Numeric output for the proportion of all known species that have been sequenced at the amplified locus
   * Identity of species that lack sequence data at the amplified locus
   * Numeric output for the proportion of amplifiable sequences that match exactly one species/genera/order or family
   
   

## Installation


```
install.packages("bsPrimerTree")
```

   or to install direct from github use:

```
devtools::install_github(MVesuviusC/Primer-Evaluation-Pipeline)
```

### Dependencies

This has been designed to work on Linux. It may work on Mac, but I don't currently have a way to test it.

Depending on how many ambiguous bases you have in your primers and how many species each primer can bind, this pipeline can require a lot of RAM to run. 40G is likely a good starting place. 

These programs need to be installed and added to your $PATH:

   * [blastn](https://www.ncbi.nlm.nih.gov/books/NBK279690/)
   * [blastdbcmd](https://www.ncbi.nlm.nih.gov/books/NBK279690/)
   * [mafft](https://mafft.cbrc.jp/alignment/software/)
   * [perl](https://www.perl.org/get.html)
   * [R](https://www.r-project.org/)
   * [getTaxaLocal.pl](https://github.com/MVesuviusC/getTaxa)
   * [makeTaxonomyDb.pl](https://github.com/MVesuviusC/getTaxa)
   * [FastTree](http://www.microbesonline.org/fasttree/)

Note that the version of blastn used needs to have the --sum-stats option available. This option was accidentally dropped from a few releases. The pipeline will fail if the wrong version is used.

You will need to have the blast nt database available as well as a taxonomy database created using (https://github.com/MVesuviusC/getTaxa)

The blast database can be created like this:
```
mkdir blastDatabaseFolder
cd blastDatabaseFolder/
update_blastdb.pl --verbose --decompress nt
```
This will take an hour or more.


The taxonomy database can be created either through R:
```
bsPrimerTree::prepare_tax_db(output_dir = "taxonomyDbFolder", 
                             tax_db = "taxonomy.db")
```
Or directly on the command line like this:
```
mkdir taxonomyDbFolder
makeTaxonomyDb.pl \
   --outDir taxonomyDbFolder \
   --databaseName taxonomy.db \
   --verbose
```
This will take half an hour or so.

You can use
```
bsPrimerTree:::missing_depends()
```
to check for the required dependencies.

## Usage


```
blasto_test <- eval_assay(
   forward="TGGTCGCAAGGCTGAAACTT",
   reverse="TTGCCTCCAGCTTCCCTACA",
   blast_exe="~/bin/ncbi-blast-2.10.1+/bin/blastn",
   blast_db="databases/blast/nt",
   tax_db="databases/taxonomy.db",
   assay_name="Blastocystis 18S",
   target_taxa = "Blastocystis",
   target_level = "genus",
   threads = 4)
```

## Output
This package will output a bsPrimerTree object. This is a list with the following elements within:

   * summary_table - A table of summary statistics for the evaluated assay.
   * amplicon_lengths - A table of amplicon lengths for all amplifiable species.
   * distance_summary - A table of genetic distance data between sequences within a species/genera/family
   * gi_taxonomy - A table of taxonomy data matched with gi identifiers. 
   * primer_mismatches - A table of primer mismatch count data for each amplified species.
   * primer_mismatch_locs - A table of primer mismatch location data for each amplified species.
   * amplifiable - A table of all species predicted to be amplifiable.
   * alignment - A DNAbin object with the alignment of all amplifiable sequences, subset to the number provided by max_aligned_seqs.
   * tree - A phylogenetic tree in nwk format of amplifiable sequences, , subset to the number provided by max_aligned_seqs.
   * amplifiableOnTarget - A table of all species within target_taxa predicted to be amplifiable.
   * species_seqd_at_locus A table of all species that have sequence available within the nt database at the amplified locus.
   * known_species - A table of all species within target_taxa.
   * missed_species - A table of species predicted to be non-amplifiable.
   * species_unsequenced_at_locus - A table of species that have no sequence data available for the amplified locus




## Docker container


This code is very much a work in progress and will likely change a good bit over time. Use with this in mind. If you try it out, feel free to send feedback to matthewvc1@gmail.com


## To do


   * Kick out genus only systematically
